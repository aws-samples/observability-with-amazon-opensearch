import { __assign } from "tslib";
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
import React, { useEffect, useRef, useState } from 'react';
import Calendar from './calendar';
import { InternalButton } from '../button/internal';
import FocusLock from '../internal/components/focus-lock';
import InternalBox from '../box/internal';
import SpaceBetween from '../space-between/index.js';
import styles from './styles.css.js';
import RelativeRangePicker from './relative-range';
import ModeSwitcher from './mode-switcher';
import clsx from 'clsx';
import InternalAlert from '../alert/internal';
import LiveRegion from '../internal/components/live-region';
import useFocusVisible from '../internal/hooks/focus-visible';
import { useDateRangePicker } from './use-date-range-picker';
export var VALID_RANGE = { valid: true };
export function DateRangePickerDropdown(_a) {
    var _b, _c;
    var _d = _a.locale, locale = _d === void 0 ? '' : _d, startOfWeek = _a.startOfWeek, isDateEnabled = _a.isDateEnabled, isValidRange = _a.isValidRange, value = _a.value, clearValue = _a.onClear, applyValue = _a.onApply, onDropdownClose = _a.onDropdownClose, relativeOptions = _a.relativeOptions, showClearButton = _a.showClearButton, isSingleGrid = _a.isSingleGrid, i18nStrings = _a.i18nStrings, dateOnly = _a.dateOnly, timeInputFormat = _a.timeInputFormat, rangeSelectorMode = _a.rangeSelectorMode, ariaLabelledby = _a.ariaLabelledby, ariaDescribedby = _a.ariaDescribedby;
    var _e = useDateRangePicker({
        value: value,
        relativeOptions: relativeOptions,
        rangeSelectorMode: rangeSelectorMode
    }), fillMissingTime = _e.fillMissingTime, rangeSelectionMode = _e.rangeSelectionMode, setRangeSelectionMode = _e.setRangeSelectionMode, selectedAbsoluteRange = _e.selectedAbsoluteRange, setSelectedAbsoluteRange = _e.setSelectedAbsoluteRange, selectedRelativeRange = _e.selectedRelativeRange, setSelectedRelativeRange = _e.setSelectedRelativeRange;
    var focusVisible = useFocusVisible();
    var scrollableContainerRef = useRef(null);
    var applyButtonRef = useRef(null);
    var _f = useState(false), applyClicked = _f[0], setApplyClicked = _f[1];
    var _g = useState(VALID_RANGE), validationResult = _g[0], setValidationResult = _g[1];
    var closeDropdown = function () {
        setApplyClicked(false);
        onDropdownClose();
    };
    var onClear = function () {
        closeDropdown();
        clearValue();
    };
    var onApply = function () {
        var newValue = rangeSelectionMode === 'relative' ? selectedRelativeRange : fillMissingTime(selectedAbsoluteRange);
        var newValidationResult = applyValue(newValue);
        if (newValidationResult.valid === false) {
            setApplyClicked(true);
            setValidationResult(newValidationResult);
        }
        else {
            setApplyClicked(false);
            closeDropdown();
        }
    };
    useEffect(function () {
        if (applyClicked) {
            var visibleRange = rangeSelectionMode === 'relative' ? selectedRelativeRange : fillMissingTime(selectedAbsoluteRange);
            var newValidationResult = isValidRange(visibleRange);
            setValidationResult(newValidationResult || VALID_RANGE);
        }
    }, [
        applyClicked,
        isValidRange,
        rangeSelectionMode,
        selectedRelativeRange,
        selectedAbsoluteRange,
        fillMissingTime,
        setValidationResult,
    ]);
    var focusRefs = {
        "default": useRef(null),
        'absolute-only': useRef(null),
        'relative-only': useRef(null)
    };
    useEffect(function () { var _a; return (_a = scrollableContainerRef.current) === null || _a === void 0 ? void 0 : _a.focus(); }, [scrollableContainerRef]);
    return (React.createElement(React.Fragment, null,
        React.createElement(FocusLock, { autoFocus: true },
            React.createElement("div", __assign({}, focusVisible, { ref: scrollableContainerRef, className: styles.dropdown, tabIndex: 0, role: "dialog", "aria-modal": "true", "aria-label": i18nStrings.ariaLabel, "aria-labelledby": ariaLabelledby !== null && ariaLabelledby !== void 0 ? ariaLabelledby : i18nStrings.ariaLabelledby, "aria-describedby": ariaDescribedby !== null && ariaDescribedby !== void 0 ? ariaDescribedby : i18nStrings.ariaDescribedby }),
                React.createElement("div", { className: clsx(styles['dropdown-content'], (_b = {},
                        _b[styles['one-grid']] = isSingleGrid,
                        _b)) },
                    React.createElement(SpaceBetween, { size: "l" },
                        React.createElement(InternalBox, { padding: { top: 'm', horizontal: 'l' } },
                            React.createElement(SpaceBetween, { direction: "vertical", size: "s" },
                                rangeSelectorMode === 'default' && (React.createElement(ModeSwitcher, { ref: focusRefs["default"], mode: rangeSelectionMode, onChange: function (mode) {
                                        setRangeSelectionMode(mode);
                                        setApplyClicked(false);
                                        setValidationResult(VALID_RANGE);
                                    }, i18nStrings: i18nStrings })),
                                rangeSelectionMode === 'absolute' && (React.createElement(Calendar, { ref: focusRefs['absolute-only'], isSingleGrid: isSingleGrid, initialEndDate: selectedAbsoluteRange === null || selectedAbsoluteRange === void 0 ? void 0 : selectedAbsoluteRange.endDate, initialStartDate: selectedAbsoluteRange === null || selectedAbsoluteRange === void 0 ? void 0 : selectedAbsoluteRange.startDate, locale: locale, startOfWeek: startOfWeek, isDateEnabled: isDateEnabled, i18nStrings: i18nStrings, onSelectDateRange: setSelectedAbsoluteRange, dateOnly: dateOnly, timeInputFormat: timeInputFormat })),
                                rangeSelectionMode === 'relative' && (React.createElement(RelativeRangePicker, { ref: focusRefs['relative-only'], isSingleGrid: isSingleGrid, options: relativeOptions, dateOnly: dateOnly, initialSelection: selectedRelativeRange, onChange: function (range) { return setSelectedRelativeRange(range); }, i18nStrings: i18nStrings }))),
                            React.createElement(InternalBox, { className: styles['validation-section'], margin: !validationResult.valid ? { top: 's' } : undefined }, !validationResult.valid && (React.createElement(React.Fragment, null,
                                React.createElement(InternalAlert, { type: "error" },
                                    React.createElement("span", { className: styles['validation-error'] }, validationResult.errorMessage)),
                                React.createElement(LiveRegion, null, validationResult.errorMessage))))),
                        React.createElement("div", { className: clsx(styles.footer, (_c = {},
                                _c[styles['one-grid']] = isSingleGrid,
                                _c[styles['has-clear-button']] = showClearButton,
                                _c)) },
                            showClearButton && (React.createElement("div", { className: styles['footer-button-wrapper'] },
                                React.createElement(InternalButton, { onClick: onClear, className: styles['clear-button'], variant: "link", formAction: "none" }, i18nStrings.clearButtonLabel))),
                            React.createElement("div", { className: styles['footer-button-wrapper'] },
                                React.createElement(SpaceBetween, { size: "xs", direction: "horizontal" },
                                    React.createElement(InternalButton, { onClick: closeDropdown, className: styles['cancel-button'], variant: "link", formAction: "none" }, i18nStrings.cancelButtonLabel),
                                    React.createElement(InternalButton, { onClick: onApply, className: styles['apply-button'], ref: applyButtonRef, formAction: "none" }, i18nStrings.applyButtonLabel))))))))));
}
//# sourceMappingURL=dropdown.js.map