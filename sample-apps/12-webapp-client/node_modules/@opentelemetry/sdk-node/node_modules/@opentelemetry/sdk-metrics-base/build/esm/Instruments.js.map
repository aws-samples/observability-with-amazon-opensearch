{"version":3,"file":"Instruments.js","sourceRoot":"","sources":["../../src/Instruments.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as api from '@opentelemetry/api';\nimport * as metrics from '@opentelemetry/api-metrics';\nimport { ObservableCallback } from '@opentelemetry/api-metrics';\nimport { hrTime } from '@opentelemetry/core';\nimport { InstrumentDescriptor } from './InstrumentDescriptor';\nimport { ObservableRegistry } from './state/ObservableRegistry';\nimport { AsyncWritableMetricStorage, WritableMetricStorage } from './state/WritableMetricStorage';\n\nexport class SyncInstrument {\n  constructor(private _writableMetricStorage: WritableMetricStorage, protected _descriptor: InstrumentDescriptor) {}\n\n  protected _record(value: number, attributes: metrics.MetricAttributes = {}, context: api.Context = api.context.active()) {\n    if (this._descriptor.valueType === metrics.ValueType.INT && !Number.isInteger(value)) {\n      api.diag.warn(\n        `INT value type cannot accept a floating-point value for ${this._descriptor.name}, ignoring the fractional digits.`\n      );\n      value = Math.trunc(value);\n    }\n    this._writableMetricStorage.record(value, attributes, context, hrTime());\n  }\n}\n\n/**\n * The class implements {@link metrics.UpDownCounter} interface.\n */\nexport class UpDownCounterInstrument extends SyncInstrument implements metrics.UpDownCounter {\n  /**\n   * Increment value of counter by the input. Inputs may be negative.\n   */\n  add(value: number, attributes?: metrics.MetricAttributes, ctx?: api.Context): void {\n    this._record(value, attributes, ctx);\n  }\n}\n\n/**\n * The class implements {@link metrics.Counter} interface.\n */\nexport class CounterInstrument extends SyncInstrument implements metrics.Counter {\n  /**\n   * Increment value of counter by the input. Inputs may not be negative.\n   */\n  add(value: number, attributes?: metrics.MetricAttributes, ctx?: api.Context): void {\n    if (value < 0) {\n      api.diag.warn(`negative value provided to counter ${this._descriptor.name}: ${value}`);\n      return;\n    }\n\n    this._record(value, attributes, ctx);\n  }\n}\n\n/**\n * The class implements {@link metrics.Histogram} interface.\n */\nexport class HistogramInstrument extends SyncInstrument implements metrics.Histogram {\n  /**\n   * Records a measurement. Value of the measurement must not be negative.\n   */\n  record(value: number, attributes?: metrics.MetricAttributes, ctx?: api.Context): void {\n    if (value < 0) {\n      api.diag.warn(`negative value provided to histogram ${this._descriptor.name}: ${value}`);\n      return;\n    }\n    this._record(value, attributes, ctx);\n  }\n}\n\nexport class ObservableInstrument implements metrics.Observable {\n  /** @internal */\n  _metricStorages: AsyncWritableMetricStorage[];\n  /** @internal */\n  _descriptor: InstrumentDescriptor;\n\n  constructor(descriptor: InstrumentDescriptor, metricStorages: AsyncWritableMetricStorage[], private _observableRegistry: ObservableRegistry) {\n    this._descriptor = descriptor;\n    this._metricStorages = metricStorages;\n  }\n\n  /**\n   * @see {metrics.Observable.addCallback}\n   */\n  addCallback(callback: ObservableCallback) {\n    this._observableRegistry.addCallback(callback, this);\n  }\n\n  /**\n   * @see {metrics.Observable.removeCallback}\n   */\n  removeCallback(callback: ObservableCallback) {\n    this._observableRegistry.removeCallback(callback, this);\n  }\n}\n\nexport class ObservableCounterInstrument extends ObservableInstrument implements metrics.ObservableCounter {}\nexport class ObservableGaugeInstrument extends ObservableInstrument implements metrics.ObservableGauge {}\nexport class ObservableUpDownCounterInstrument extends ObservableInstrument implements metrics.ObservableUpDownCounter {}\n\nexport function isObservableInstrument(it: unknown): it is ObservableInstrument {\n  return it instanceof ObservableInstrument;\n}\n"]}